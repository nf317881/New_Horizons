# Handoff State: New Horizons AI World Generator

## ðŸŒŒ Project Overview
A procedural alien world explorer using **Three.js**, **React Three Fiber**, and **AI-driven assets**.
*   **Terrain**: Infinite chunk-based system with multi-layered simplex noise.
*   **Props**: Unique alien flora generated on-the-fly via **Meshy AI**.
*   **Biomes**: High-level creative descriptions and technical parameters generated by **Gemini Flash**.

## ðŸ› ï¸ Current Implementation Status
1.  **Multi-Prop System**: Replaced the single-flora system with a `props` array in `BiomeData`. Supports 3-5 unique objects per biome.
2.  **Meshy AI V2 integration**:
    *   **The Chain**: Now performs `Preview` -> `Refine` (Texturing) tasks sequentially.
    *   **Queue Logic**: Implemented retry/backoff for "NoMoreConcurrentTasks" limits.
3.  **Prop Placement Engine**:
    *   **Alignment**: Props tilt based on terrain normal (4-point central difference).
    *   **Anchoring**: Automatic bounding-box calculation ensures model bases touch the ground.
    *   **Randomization**: Deterministic variety (rotation/position) using seed bucketing to prevent prop stacking.
4.  **Polish & Controls**:
    *   **Lighting**: Directional light follows the player with a tuned shadow frustum to eliminate acne/ghosting.
    *   **Leva UI**: Grouped folders for manual override of Terrain (colors, noise, layers) and Props (density, scale).
    *   **Navigation**: Toggle between `Fly` and `Walk` (grounded physics) modes.

## ðŸ“ Key Code Architecture
*   **`App.tsx`**: Main entry, scene setup, global lighting, and Leva management.
*   **`PropManager.tsx`**: Deterministic spawning logic. Calculates world-to-noise mapping (Z inversion fix included).
*   **`MeshyProp.tsx`**: Component level state for polling, caching, and 3D model processing (pivot groups for alignment).
*   **`services/meshy.ts`**: API wrapper handling the Preview->Refine sequence.
*   **`services/ai.ts`**: Biome metadata generation with structured JSON schema.

## ðŸ’¡ Important Context for the "Next Me"
*   **Coordinate System**: Terrain uses `PlaneGeometry` rotated -90deg on X. Global Z in noise maps to local Y in geometry. `PropManager` must maintain exact parity with `Terrain.tsx` height sampling to avoid floating objects.
*   **Leva Key Uniqueness**: Always use `label` for UI text and unique internal IDs for keys when many similar controls exist (like `prop_N_density`).
*   **Shadow Scaling**: The shadow camera is currently `[-100, 100]` and follows the player. If world objects get much larger, this frustum might need widening.

## ðŸš€ Next Steps / Future Ideas
*   [ ] **Optimization**: InstancedRendering for props to handle much higher densities.
*   [ ] **Asset Management**: Permanent storage for generated GLBs (beyond session cache).
*   [ ] **Atmosphere**: More advanced shader-based skies (currently uses Equirectangular textures).
*   [ ] **Complexity**: Adding "POI" (Point of Interest) generation logic (crashes, structures).
